<div class="dashboard-container" *ngIf="company">
  <h2>Company Dashboard</h2>

  <section class="company-info">
    <div class="company-info-grid">
      <div><span class="label">Id</span><span class="value">{{ company.id }}</span></div>
      <div><span class="label">Name</span><span class="value">{{ company.name }}</span></div>
      <div><span class="label">Tax Code</span><span class="value">{{ company.taxCode }}</span></div>
      <div>
        <span class="label">Status</span>
        <span class="value" [class.badge-active]="company.status === 1" [class.badge-inactive]="company.status !== 1">
          {{ company.status === 1 ? 'Active' : 'Not Active' }}
        </span>
      </div>
      <div><span class="label">Reg Date</span><span class="value">{{ company.regDate | date }}</span></div>
    </div>
  </section>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'requests'" (click)="setTab('requests')">
      Requests
    </button>
    <button class="tab" [class.active]="activeTab === 'products'" (click)="setTab('products')">
      Products
    </button>
  </div>

  <!-- Requests Tab -->
  <section *ngIf="activeTab === 'requests'" class="panel">
    <div class="panel-header">
      <h3>Requests</h3>

      <div class="actions">
        <button class="secondary" (click)="loadRequests()" [disabled]="requestsLoading">Refresh</button>
        <button (click)="onRequestView()" [disabled]="!selectedRequest">View</button>
        <button (click)="onRequestAdd()">Add</button>
        <button (click)="onRequestEdit()" [disabled]="!selectedRequest || (+selectedRequest?.status) !== 1">Edit</button>
        <button class="danger" (click)="onRequestDelete()" [disabled]="requestsLoading || !selectedRequest || (+selectedRequest?.status) !== 1">Delete</button>
      </div>
    </div>

    <div *ngIf="requestsLoading" class="info">Loading requests...</div>

    <table *ngIf="!requestsLoading && requests.length > 0" class="grid">
      <thead>
        <tr>
          <th>Id</th>
          <th>Prod Id</th>
          <th>ServiceTokenCount</th>
          <th>Reg Date</th>
          <th>Status</th>
          <th>Authorize Date</th>
          <th>Approve Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of requests"
          (click)="selectRequest(r)"
          [class.selected]="selectedRequest?.id === r.id">
          <td>{{ r.id }}</td>
          <td>{{ r.prodId }}</td>
          <td>{{ r.serviceTokenCount }}</td>
          <td>{{ r.regDate | date: 'medium' }}</td>
          <td>{{ requestStatusLabel(r.status) }}</td>
          <td>{{ r.authorizeDate ? (r.authorizeDate | date: 'medium') : '-' }}</td>
          <td>{{ r.approveDate ? (r.approveDate | date: 'medium') : '-' }}</td>
          <td>
            <div class="row-actions">
              <button (click)="authorizeRequestRow(r, $event)" [disabled]="requestsLoading || (+r.status) !== 1">Authorize</button>
              <button (click)="deauthorizeRequestRow(r, $event)" [disabled]="requestsLoading || (+r.status) !== 2">Deauthorize</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!requestsLoading && requests.length === 0" class="muted">
      No requests found for this company.
    </div>


  </section>

  <!-- Products Tab -->
  <section *ngIf="activeTab === 'products'" class="panel">
    <div class="panel-header">
      <h3>Products</h3>

      <div class="actions">
        <button (click)="onProductView()" [disabled]="!selectedProduct">View</button>
        <button (click)="onProductAdd()">Add</button>
        <button (click)="onProductEdit()" [disabled]="!selectedProduct">Edit</button>
        <button (click)="onProductDelete()" [disabled]="!selectedProduct">Delete</button>
        <button class="secondary" (click)="reloadProducts()" [disabled]="productsLoading">Refresh</button>
      </div>
    </div>

    <div class="search-row">
      <input
        type="text"
        [(ngModel)]="productSearch"
        placeholder="Search (server-side, optional)"
        (keyup.enter)="reloadProducts()" />
      <button class="secondary" (click)="reloadProducts()" [disabled]="productsLoading">Search</button>
      <button class="secondary" (click)="loadMoreProducts()" [disabled]="productsLoading">Load more</button>
    </div>

    <div *ngIf="productsLoading" class="info">Loading products...</div>

    <table *ngIf="!productsLoading && products.length > 0" class="grid">
      <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Service Count</th>
          <th>Price</th>
          <th>Term</th>
          <th>Schedule Type</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let p of products"
          (click)="selectProduct(p)"
          [class.selected]="selectedProduct?.id === p.id">
          <td>{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.serviceCount }}</td>
          <td>{{ p.price }}</td>
          <td>{{ p.term ?? '-' }}</td>
          <td>{{ scheduleTypeLabel(p.scheduleType.periodType, p.scheduleType.periodNumber) }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!productsLoading && products.length === 0" class="muted">
      No products found for this company.
    </div>
  </section>

  <a routerLink="/" class="back-link">Back to main page</a>

  <!-- Modal -->
  <div class="modal-backdrop" *ngIf="modalOpen">
    <div class="modal">
      <div class="modal-header">
        <h3>{{ modalTitle }}</h3>
        <button class="icon-btn" (click)="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div *ngIf="modalLoading" class="info">Loading...</div>
        <div *ngIf="modalError" class="error" role="alert">
          <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 8v4m0 4h.01"/>
          </svg>
          {{ modalError }}
        </div>

        <!-- Request View -->
        <ng-container *ngIf="modalMode === 'requestView' && modalRequest">
          <dl class="details">
            <div><dt>Id</dt><dd>{{ modalRequest.id }}</dd></div>
            <div><dt>Row Version</dt><dd>{{ modalRequest.rowVersion }}</dd></div>
            <div><dt>Company Id</dt><dd>{{ modalRequest.companyId }}</dd></div>
            <div><dt>Prod Id</dt><dd>{{ modalRequest.prodId }}</dd></div>
            <div><dt>ServiceTokenCount</dt><dd>{{ modalRequest.serviceTokenCount }}</dd></div>
            <div><dt>Reg Date</dt><dd>{{ modalRequest.regDate | date: 'medium' }}</dd></div>
            <div><dt>Status</dt><dd>{{ requestStatusLabel(modalRequest.status) }}</dd></div>
            <div><dt>Authorize Date</dt><dd>{{ modalRequest.authorizeDate ? (modalRequest.authorizeDate | date: 'medium') : '-' }}</dd></div>
            <div><dt>Approve Date</dt><dd>{{ modalRequest.approveDate ? (modalRequest.approveDate | date: 'medium') : '-' }}</dd></div>
          </dl>
        </ng-container>

        <!-- Request Add/Edit -->
        <ng-container *ngIf="modalMode === 'requestAdd' || modalMode === 'requestEdit'">
          <form (ngSubmit)="modalMode === 'requestAdd' ? submitRequestAdd() : submitRequestEdit()" class="form">
            <label>
              Select Product (recommended)
              <select [(ngModel)]="requestForm.prodId" name="prodId">
                <option [ngValue]="0">-- Select --</option>
                <option *ngFor="let p of products" [ngValue]="p.id">
                  {{ p.name }} (Id: {{ p.id }})
                </option>
              </select>
            </label>

            <label>
              Or enter Product Id manually
              <input type="number" [(ngModel)]="requestFormProdIdManual" name="prodIdManual" min="1" />
            </label>

            <label>
              Service Token Count
              <input type="number" [(ngModel)]="requestForm.serviceTokenCount" name="serviceTokenCount" min="1" required />
            </label>

            <div class="modal-actions">
              <button type="submit" [disabled]="modalLoading">
                {{ modalMode === 'requestAdd' ? 'Create' : 'Save' }}
              </button>
              <button type="button" class="secondary" (click)="closeModal()">Cancel</button>
            </div>
          </form>
        </ng-container>

        <!-- Product View -->
        <ng-container *ngIf="modalMode === 'productView' && modalProduct">
          <dl class="details">
            <div><dt>Id</dt><dd>{{ modalProduct.id }}</dd></div>
            <div><dt>Company Id</dt><dd>{{ modalProduct.companyId }}</dd></div>
            <div><dt>Name</dt><dd>{{ modalProduct.name }}</dd></div>
            <div><dt>Service Count</dt><dd>{{ modalProduct.serviceCount }}</dd></div>
            <div><dt>Price</dt><dd>{{ modalProduct.price }}</dd></div>
            <div><dt>Term</dt><dd>{{ modalProduct.term ?? '-' }}</dd></div>
            <div><dt>Schedule Type</dt><dd>{{ scheduleTypeLabel(modalProduct.scheduleType.periodType, modalProduct.scheduleType.periodNumber) }}</dd></div>
          </dl>
        </ng-container>

        <!-- Product Add/Edit -->
        <ng-container *ngIf="modalMode === 'productAdd' || modalMode === 'productEdit'">
          <form #productFormRef="ngForm" (ngSubmit)="productFormRef.valid ? (modalMode === 'productAdd' ? submitProductAdd() : submitProductEdit()) : null" class="form">
            <label [class.has-error]="nameInput.invalid && nameInput.touched">
              Name
              <input
                type="text"
                [(ngModel)]="productForm.name"
                name="name"
                #nameInput="ngModel"
                required
                minlength="2" />
              <span class="validation-error" *ngIf="nameInput.invalid && nameInput.touched">
                <span *ngIf="nameInput.errors?.['required']">Name is required</span>
                <span *ngIf="nameInput.errors?.['minlength']">Name must be at least 2 characters</span>
              </span>
            </label>

            <label [class.has-error]="serviceCountInput.invalid && serviceCountInput.touched">
              Service Count
              <input
                type="number"
                [(ngModel)]="productForm.serviceCount"
                name="serviceCount"
                #serviceCountInput="ngModel"
                min="0"
                required />
              <span class="validation-error" *ngIf="serviceCountInput.invalid && serviceCountInput.touched">
                <span *ngIf="serviceCountInput.errors?.['required']">Service count is required</span>
                <span *ngIf="serviceCountInput.errors?.['min']">Service count must be at least 0</span>
              </span>
            </label>

            <label [class.has-error]="priceInput.invalid && priceInput.touched">
              Price
              <input
                type="number"
                step="0.01"
                [(ngModel)]="productForm.price"
                name="price"
                #priceInput="ngModel"
                min="0.01"
                required />
              <span class="validation-error" *ngIf="priceInput.invalid && priceInput.touched">
                <span *ngIf="priceInput.errors?.['required']">Price is required</span>
                <span *ngIf="priceInput.errors?.['min']">Price must be greater than 0</span>
              </span>
            </label>

            <label>
              Term (optional)
              <input type="number" [(ngModel)]="productForm.term" name="term" min="1" />
            </label>

            <label>
              Schedule Period Type
              <select [(ngModel)]="productForm.scheduleType.periodType" name="periodType">
                <option [ngValue]="0">None</option>
                <option [ngValue]="1">Daily</option>
                <option [ngValue]="2">Weekly</option>
                <option [ngValue]="3">Monthly</option>
                <option [ngValue]="4">Yearly</option>
              </select>
            </label>

            <label>
              Schedule Period Number (optional)
              <input type="number" [(ngModel)]="productForm.scheduleType.periodNumber" name="periodNumber" min="1" />
              <span class="helper">Label: {{ scheduleTypeLabel(productForm.scheduleType.periodType, productForm.scheduleType.periodNumber) }}</span>
            </label>

            <div class="modal-actions">
              <button type="submit" [disabled]="modalLoading || productFormRef.invalid">
                {{ modalMode === 'productAdd' ? 'Create' : 'Save' }}
              </button>
              <button type="button" class="secondary" (click)="closeModal()">Cancel</button>
            </div>
          </form>
        </ng-container>
      </div>
    </div>
  </div>
</div>
