<div class="dashboard-container" *ngIf="company">
  <h2>Company Dashboard</h2>

  <section class="company-info">
    <div class="company-info-grid">
      <div><span class="label">Id</span><span class="value">{{ company.id }}</span></div>
      <div><span class="label">Name</span><span class="value">{{ company.name }}</span></div>
      <div><span class="label">Tax Code</span><span class="value">{{ company.taxCode }}</span></div>
      <div>
        <span class="label">Status</span>
        <span class="value" [class.badge-active]="company.status === 1" [class.badge-inactive]="company.status !== 1">
          {{ company.status === 1 ? 'Active' : 'Not Active' }}
        </span>
      </div>
      <div><span class="label">Reg Date</span><span class="value">{{ company.regDate | date }}</span></div>
    </div>
  </section>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'requests'" (click)="setTab('requests')">
      Requests
    </button>
    <button class="tab" [class.active]="activeTab === 'products'" (click)="setTab('products')">
      Products
    </button>
  </div>

  <!-- Requests Tab -->
  <section *ngIf="activeTab === 'requests'" class="panel">
    <div class="panel-header">
      <h3>Requests</h3>

      <div class="actions">
        <button (click)="onRequestView()" [disabled]="!selectedRequest">View</button>
        <button (click)="onRequestAdd()">Add</button>
        <button (click)="onRequestEdit()" [disabled]="!selectedRequest">Edit</button>
        <button (click)="onRequestDelete()" [disabled]="!selectedRequest">Delete</button>
        <button class="secondary" (click)="loadRequests()" [disabled]="requestsLoading">Refresh</button>
      </div>
    </div>

    <div *ngIf="requestsLoading" class="info">Loading requests...</div>

    <table *ngIf="!requestsLoading && requests.length > 0" class="grid">
      <thead>
        <tr>
          <th>Id</th>
          <th>Prod Id</th>
          <th>Reg Date</th>
          <th>Status</th>
          <th>Authorize Date</th>
          <th>Approve Date</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of requests"
          (click)="selectRequest(r)"
          [class.selected]="selectedRequest?.id === r.id">
          <td>{{ r.id }}</td>
          <td>{{ r.prodId }}</td>
          <td>{{ r.regDate | date: 'medium' }}</td>
          <td>{{ requestStatusLabel(r.status) }}</td>
          <td>{{ r.authorizeDate ? (r.authorizeDate | date: 'medium') : '-' }}</td>
          <td>{{ r.approveDate ? (r.approveDate | date: 'medium') : '-' }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!requestsLoading && requests.length === 0" class="muted">
      No requests found for this company.
    </div>

    <div class="hint">
      Note: per the provided backend signatures, the Requests tab uses Product.Update/Delete with the selected request’s ProdId.
    </div>
  </section>

  <!-- Products Tab -->
  <section *ngIf="activeTab === 'products'" class="panel">
    <div class="panel-header">
      <h3>Products</h3>

      <div class="actions">
        <button (click)="onProductView()" [disabled]="!selectedProduct">View</button>
        <button (click)="onProductAdd()">Add</button>
        <button (click)="onProductEdit()" [disabled]="!selectedProduct">Edit</button>
        <button (click)="onProductDelete()" [disabled]="!selectedProduct">Delete</button>
        <button class="secondary" (click)="reloadProducts()" [disabled]="productsLoading">Refresh</button>
      </div>
    </div>

    <div class="search-row">
      <input
        type="text"
        [(ngModel)]="productSearch"
        placeholder="Search (server-side, optional)"
        (keyup.enter)="reloadProducts()" />
      <button class="secondary" (click)="reloadProducts()" [disabled]="productsLoading">Search</button>
      <button class="secondary" (click)="loadMoreProducts()" [disabled]="productsLoading">Load more</button>
    </div>

    <div *ngIf="productsLoading" class="info">Loading products...</div>

    <table *ngIf="!productsLoading && products.length > 0" class="grid">
      <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Total Qty</th>
          <th>Price</th>
          <th>Term</th>
          <th>Schedule Type</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let p of products"
          (click)="selectProduct(p)"
          [class.selected]="selectedProduct?.id === p.id">
          <td>{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.totalQuantity }}</td>
          <td>{{ p.price }}</td>
          <td>{{ p.term ?? '-' }}</td>
          <td>{{ scheduleTypeLabel(p.scheduleType) }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!productsLoading && products.length === 0" class="muted">
      No products found for this company.
    </div>
  </section>

  <a routerLink="/" class="back-link">Back to main page</a>

  <!-- Modal -->
  <div class="modal-backdrop" *ngIf="modalOpen">
    <div class="modal">
      <div class="modal-header">
        <h3>{{ modalTitle }}</h3>
        <button class="icon-btn" (click)="closeModal()">×</button>
      </div>

      <div class="modal-body">
        <div *ngIf="modalLoading" class="info">Loading...</div>
        <div *ngIf="modalError" class="error">{{ modalError }}</div>

        <!-- Request View -->
        <ng-container *ngIf="modalMode === 'requestView' && modalRequest">
          <dl class="details">
            <div><dt>Id</dt><dd>{{ modalRequest.id }}</dd></div>
            <div><dt>Row Version</dt><dd>{{ modalRequest.rowVersion | date: 'medium' }}</dd></div>
            <div><dt>Company Id</dt><dd>{{ modalRequest.companyId }}</dd></div>
            <div><dt>Prod Id</dt><dd>{{ modalRequest.prodId }}</dd></div>
            <div><dt>Reg Date</dt><dd>{{ modalRequest.regDate | date: 'medium' }}</dd></div>
            <div><dt>Status</dt><dd>{{ requestStatusLabel(modalRequest.status) }}</dd></div>
            <div><dt>Authorize Date</dt><dd>{{ modalRequest.authorizeDate ? (modalRequest.authorizeDate | date: 'medium') : '-' }}</dd></div>
            <div><dt>Approve Date</dt><dd>{{ modalRequest.approveDate ? (modalRequest.approveDate | date: 'medium') : '-' }}</dd></div>
          </dl>
        </ng-container>

        <!-- Request Add -->
        <ng-container *ngIf="modalMode === 'requestAdd'">
          <form (ngSubmit)="submitRequestAdd()" class="form">
            <label>
              Select Product (recommended)
              <select [(ngModel)]="requestForm.prodId" name="prodId">
                <option [ngValue]="0">-- Select --</option>
                <option *ngFor="let p of products" [ngValue]="p.id">
                  {{ p.name }} (Id: {{ p.id }})
                </option>
              </select>
            </label>

            <label>
              Or enter Product Id manually
              <input type="number" [(ngModel)]="requestFormProdIdManual" name="prodIdManual" min="1" />
            </label>

            <div class="modal-actions">
              <button type="submit" [disabled]="modalLoading">Create</button>
              <button type="button" class="secondary" (click)="closeModal()">Cancel</button>
            </div>
          </form>
        </ng-container>

        <!-- Product View -->
        <ng-container *ngIf="modalMode === 'productView' && modalProduct">
          <dl class="details">
            <div><dt>Id</dt><dd>{{ modalProduct.id }}</dd></div>
            <div><dt>Company Id</dt><dd>{{ modalProduct.companyId }}</dd></div>
            <div><dt>Name</dt><dd>{{ modalProduct.name }}</dd></div>
            <div><dt>Total Quantity</dt><dd>{{ modalProduct.totalQuantity }}</dd></div>
            <div><dt>Price</dt><dd>{{ modalProduct.price }}</dd></div>
            <div><dt>Term</dt><dd>{{ modalProduct.term ?? '-' }}</dd></div>
            <div><dt>Schedule Type</dt><dd>{{ scheduleTypeLabel(modalProduct.scheduleType) }} ({{ modalProduct.scheduleType }})</dd></div>
          </dl>
        </ng-container>

        <!-- Product Add/Edit -->
        <ng-container *ngIf="modalMode === 'productAdd' || modalMode === 'productEdit' || modalMode === 'productEditFromRequest'">
          <form (ngSubmit)="modalMode === 'productAdd' ? submitProductAdd() : submitProductEdit()" class="form">
            <label>
              Name
              <input type="text" [(ngModel)]="productForm.name" name="name" required />
            </label>

            <label>
              Total Quantity
              <input type="number" [(ngModel)]="productForm.totalQuantity" name="totalQuantity" min="0" required />
            </label>

            <label>
              Price
              <input type="number" step="0.01" [(ngModel)]="productForm.price" name="price" required />
            </label>

            <label>
              Term (optional)
              <input type="number" [(ngModel)]="productForm.term" name="term" />
            </label>

            <label>
              Schedule Type (number)
              <input type="number" [(ngModel)]="productForm.scheduleType" name="scheduleType" />
              <span class="helper">Label: {{ scheduleTypeLabel(productForm.scheduleType) }}</span>
            </label>

            <div class="modal-actions">
              <button type="submit" [disabled]="modalLoading">
                {{ modalMode === 'productAdd' ? 'Create' : 'Save' }}
              </button>
              <button type="button" class="secondary" (click)="closeModal()">Cancel</button>
            </div>
          </form>
        </ng-container>
      </div>
    </div>
  </div>
</div>
